<!doctype html>
<html>
	<head>
		<title>multiple jsPlumb instances demonstration</title>
		<link rel="stylesheet" href="../css/multipleJsPlumbDemo.css"></link>
	</head>
	<body>
		<div id="info">
			What's happening here?
			<ul>
				<li>This is a demonstration of how you can run several jsPlumb instances in the same page: each rectangle contains a separate jsPlumb instance</li>
				<li>You can drag each rectangle around the screen independently</li>  
				<li>This demo uses jsPlumb 1.2.5, MooTools 1.2.4 and Drag.Move from MooTools More 1.2.4.4.</li>
			</ul>
		</div>
		<div id="container" class="container"><button disabled class="clear" rel="1">clear these</button><button disabled class="redo" rel="1">redraw these</button><!-- button class="anim" rel="1">animate these</button--></div>
		<div id="container2" class="container"><button disabled class="clear" rel="2">clear these</button><button disabled class="redo" rel="2">redraw these</button><!-- button class="anim" rel="2">animate these</button--></div>
		<div id="container3" class="container"><button disabled class="clear" rel="3">clear these</button><button disabled class="redo" rel="3">redraw these</button><!-- button class="anim" rel="3">animate these</button--></div>
	
		<script type="text/javascript" src="http://explorercanvas.googlecode.com/svn/trunk/excanvas.js"></script>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/mootools/1.2.4/mootools-yui-compressed.js"></script>
		<script type="text/javascript" src="../../js/mootools-1.2.4.4-more.js"></script>
		<script type="text/javascript" src="http://jsplumb.googlecode.com/svn/trunk/js/1.2.5/jsPlumb-1.2.5-RC1.js"></script>
		<script type="text/javascript" src="http://jsplumb.googlecode.com/svn/trunk/js/1.2.5/jsPlumb-defaults-1.2.5-RC1.js"></script>
		<script type="text/javascript" src="http://jsplumb.googlecode.com/svn/trunk/js/1.2.5/mootools.jsPlumb-1.2.5-RC1.js"></script>
		<script type="text/javascript" src="http://jsplumb.googlecode.com/svn/trunk/js/1.2.5/jsBezier-0.2-min.js"></script>
		
		<script type="text/javascript">
		window.addEvent('domready', function() {

			// chrome fix.
			document.onselectstart = function () { return false; };
			

// ********************* jsPlumb instances ******************************************				
				
				var jsPlumb1 = jsPlumb.getInstance();								
				var color = '#550';
				// note here we set defaults on this instance, not the static jsPlumb instance.
				jsPlumb1.Defaults.PaintStyle = { lineWidth:1, strokeStyle:color};
				jsPlumb1.Defaults.Connector = new jsPlumb.Connectors.Straight();
				jsPlumb1.Defaults.Endpoint = new jsPlumb.Endpoints.Dot({radius:3});
				jsPlumb.Defaults.EndpointStyle = { fillStyle: color };
				jsPlumb1.Defaults.Anchors = [ jsPlumb.Anchors.Center, jsPlumb.Anchors.Center ];
				jsPlumb1.Defaults.Container = 'container';

				var color2='rgba(31, 46, 61, 0.3)';
				// in this example we pass the defaults in to the jsPlumb instance.
				var jsPlumb2 = jsPlumb.getInstance({
					PaintStyle:{lineWidth:5, strokeStyle:color2},
					Connector:new jsPlumb.Connectors.Bezier(),
					Endpoint:new jsPlumb.Endpoints.Dot({radius:17}),
					EndpointStyle : { fillStyle: color2  },
					Anchor :  jsPlumb.Anchors.Center,
					Container : 'container2'
				});

				var color3='green';
				// in this example we pass the defaults in to the jsPlumb instance.
				var jsPlumb3 = jsPlumb.getInstance({
					PaintStyle:{lineWidth:3, strokeStyle:color3},
					Connector:new jsPlumb.Connectors.Bezier(30),
					Endpoint:new jsPlumb.Endpoints.Dot({radius:5}),
					EndpointStyle : { fillStyle: color3  },
					Anchor :  [0.5,0.5,1,1],
					Container : 'container3'
				});				

// *************************** blips to draw, drawing functions etc *****************************

				var startX = 4.5, startY = 3;
				var blipWidth = 1, blipHeight = 1;
				var blipX = 3, blipY = 3;
				var spacer = 3.9;
				
				var getId = function(x, y, prefix) { return 'blip_' + (prefix ? prefix : '') + x + '_' + y; };
				var getLeft = function(x) { return startX + (blipWidth + (x * (blipWidth * spacer))) + 'em'; };
				var getTop = function(y) { return startY + (blipHeight + (y * (blipHeight * spacer))) + 'em'; };
				var getOthers = function(x, y, prefix) {
					var others = [];
					if (x > 0) others.push(getId(x-1, y, prefix));
					if (x < blipX - 1) others.push(getId(x + 1, y, prefix));					
					if (y > 0) others.push(getId(x, y-1, prefix));
					if (x > 0 && y > 0) others.push(getId(x-1, y-1, prefix));
					if (x < blipX - 1 && y > 0) others.push(getId(x+1, y-1, prefix));
					return others;
				}				

				var createBlips = function(elId, blipClass, prefix) {
					var container = document.getElementById(elId);
					for (var i = 0; i < blipX; i++) {
						for (var j = 0; j < blipY; j++) {
							var b = document.createElement("div");
							b.className = 'blip ' + blipClass;
							container.appendChild(b);
							b.id= getId(i, j, prefix);
							b.style.position = 'absolute';
							b.style.left = getLeft(i);
							b.style.top = getTop(j);
						}
					}
				};

				createBlips('container', "blip1");
				createBlips('container2', "blip2", '2_');
				createBlips('container3', "blip3", '3_');				

// ********************** plumbing code *************************************************

				var connectFunction = function(source, target, jsPlumbInstance) {
					jsPlumbInstance.connect( {source:source, target:target });
				};
				
				var draw = function(jsPlumbInstance, prefix) {					
					for (var i = 0; i < blipX; i++) {
						for (var j = 0; j < blipY; j++) {
							var others = getOthers(i, j, prefix);
							var id = getId(i, j, prefix);
							for (var k = 0 ; k < others.length; k++) {
								connectFunction(id, others[k], jsPlumbInstance);							
							}
						}
					}
				};

				draw(jsPlumb1);
				draw(jsPlumb2,'2_');
				draw(jsPlumb3,'3_');

// *********************** button setup ******************************************
				
				var jsPlumbs = {'1':jsPlumb1,  '2':jsPlumb2, '3':jsPlumb3};
				var prefixes = {'1':null,  '2':'2_', 3:'3_'};
				
				$$(".clear").each(function(c) {
					c.addEvent('click', function() {
						var j = c.get("rel");
						jsPlumbs[j].detachEverything();
						//$(".redo[rel=" + j + "]").attr('disabled',false);
					});
					c.set("disabled", false);
				});

				$$(".redo").each(function(r) {
					r.addEvent('click', function() {
						var j = r.get("rel");
						draw(jsPlumbs[j], prefixes[j]);
						r.set('disabled',true);
					});
				});
	

				new Drag.Move($(".container"));
			});
		</script>
	</body>
</html>